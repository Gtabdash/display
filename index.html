<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Gnosjö Trafik AB - LIVE</title>
    <style>
        :root { --bg: #0b0d14; --card: #161b22; --text: #c9d1d9; --accent: #1f6feb; --warn: #da3633; --driver: #afffb4; --label: #f0f6fc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; overflow: hidden; }
        
        .header { display: flex; justify-content: space-between; align-items: center; background: var(--card); padding: 8px 20px; border-radius: 6px; margin-bottom: 10px; border: 1px solid #30363d; }
        .day-indicator { color: var(--accent); font-weight: bold; font-size: 1.1em; text-transform: uppercase; text-shadow: 0 0 10px rgba(31, 111, 235, 0.3); }

        .board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .column { display: flex; flex-direction: column; gap: 2px; }
        .col-header { display: flex; gap: 8px; padding: 0 6px; margin-bottom: 2px; font-size: 0.6em; font-weight: bold; color: var(--accent); text-transform: uppercase; }
        
        .h-bil { width: 105px; } .h-slap { width: 110px; text-align: center; } .h-chauffor { flex-grow: 1; text-align: left; padding-left: 5px; }
        
        .vehicle-card { background: var(--card); padding: 0 8px; border-radius: 4px; border: 1px solid #30363d; display: flex; align-items: center; gap: 8px; height: 30px; box-sizing: border-box; }
        .manual-row { background: #1c2128; border-left: 4px solid var(--accent); }
        .row-label { width: 105px; font-size: 0.75em; font-weight: bold; color: var(--label); white-space: nowrap; overflow: hidden; }
        
        .v-badge { background: #30363d; color: #fff; border-radius: 3px; font-weight: bold; font-size: 0.75em; width: 40px; text-align: center; border: 1px solid var(--accent); height: 20px; line-height: 20px; flex-shrink: 0; }
        .v-badge.p-car { border-color: var(--warn); background: #491110; }
        
        .reg-plate { background: white; color: black; padding: 0 2px 0 10px; border-radius: 2px; font-family: 'Consolas', monospace; font-weight: bold; font-size: 0.8em; position: relative; border: 1px solid #000; width: 60px; text-align: center; height: 20px; line-height: 20px; flex-shrink: 0; }
        .reg-plate::before { content: "S"; position: absolute; left: 0; top: 0; bottom: 0; width: 9px; background: #003399; color: white; font-size: 0.5em; display: flex; align-items: center; justify-content: center; }
        
        .display-text { font-weight: bold; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .trailer-text { color: #e1d0ff; width: 110px; text-align: center; flex-shrink: 0; }
        
        /* Chaufför och Info delar nu på utrymmet sömlöst */
        .driver-info-wrapper { display: flex; flex-grow: 1; align-items: center; min-width: 0; }
        .driver-text { color: var(--driver); flex-shrink: 0; margin-right: 10px; }
        .info-text { color: #8b949e; font-size: 0.9em; font-style: italic; flex-grow: 1; text-align: right; overflow: hidden; text-overflow: ellipsis; }

        #clock { font-family: monospace; font-size: 1.2em; color: var(--text); }
    </style>
</head>
<body>

<div class="header">
    <div style="font-size: 1.2em; font-weight: bold;">GNOSJÖ TRAFIK AB</div>
    <div class="day-indicator" id="dayDisplay">LADDAR...</div>
    <div id="clock"></div>
</div>

<div class="board" id="mainBoard">
    <div class="column" id="col1"></div>
    <div class="column" id="col2"></div>
    <div class="column" id="col3"></div>
</div>

<script>
    let vehicles = []; const manualRows = ["Lager Gnosjö", "Lager Hörle", "Lager Anderstorp", "TL 1", "TL 2", "TL 3"];

    function getTargetDate() {
        let now = new Date();
        let target = new Date();
        if (now.getHours() >= 18) { target.setDate(now.getDate() + 1); }
        if (target.getDay() === 6) { target.setDate(target.getDate() + 2); }
        else if (target.getDay() === 0) { target.setDate(target.getDate() + 1); }
        return target;
    }

    async function init() {
        const target = getTargetDate();
        const dateStr = target.toISOString().split('T')[0];
        const options = { weekday: 'long', day: 'numeric', month: 'short' };
        document.getElementById('dayDisplay').innerText = target.toLocaleDateString('sv-SE', options);

        const r = await fetch('api.php?action=get_resources');
        const d = await r.json();
        vehicles = d.vehicles;
        
        renderEmptyBoard();
        await loadPlan(dateStr);
    }

    function renderEmptyBoard() {
        const allRows = [...vehicles.map((v, i) => ({type: 'V', data: v, id: i}))];
        manualRows.forEach((m, i) => allRows.push({type: 'M', data: m, id: 100+i}));
        const perCol = Math.ceil(allRows.length / 3);
        for(let c=1; c<=3; c++) {
            const col = document.getElementById('col'+c);
            col.innerHTML = `<div class="col-header"><div class="h-bil">Enhet</div><div class="h-slap">Släp</div><div class="h-chauffor">Chaufför & Info</div></div>`;
            allRows.slice((c-1)*perCol, c*perCol).forEach(row => {
                const card = document.createElement('div');
                card.className = 'vehicle-card' + (row.type === 'M' ? ' manual-row' : '');
                if(row.type === 'V') {
                    card.innerHTML = `
                        <div class="v-badge ${row.data.t==='P'?'p-car':''}" id="badge-${row.id}">${row.data.n}</div>
                        <div class="reg-plate">${row.data.r}</div>
                        <div class="display-text trailer-text" id="z-${row.id}-t"></div>
                        <div class="driver-info-wrapper">
                            <div class="display-text driver-text" id="z-${row.id}-d"></div>
                            <div class="info-text" id="info-${row.id}"></div>
                        </div>`;
                } else {
                    card.innerHTML = `
                        <div class="row-label">${row.data}</div>
                        <div style="display:flex; gap:10px; flex-grow:1; align-items:center;">
                            <div class="display-text trailer-text" id="z-${row.id}-m1" style="text-align:left; width:120px"></div>
                            <div class="display-text driver-text" id="z-${row.id}-m2"></div>
                        </div>`;
                }
                col.appendChild(card);
            });
        }
    }

    async function loadPlan(date) {
        const res = await fetch(`api.php?action=load_plan&date=${date}`);
        const items = await res.json();
        items.forEach(item => {
            const zone = document.getElementById(item.slot_id);
            if(zone) {
                if(item.item_type === 'trailer') {
                    const p = item.raw_data.split('|');
                    zone.innerHTML = `<span style="font-size:0.75em; background:#30363d; padding:1px 3px; border-radius:2px; margin-right:3px; border:1px solid var(--accent)">${p[0]}</span> ${p[1]}`;
                } else {
                    zone.innerText = item.raw_data.split('|')[0];
                }
                const info = document.getElementById(`info-${item.row_id || item.slot_id.split('-')[1]}`);
                if(info && item.info_text) info.innerText = item.info_text;
            }
        });
    }

    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString('sv-SE'); }, 1000);
    setInterval(() => { location.reload(); }, 300000);
    window.onload = init;
</script>
</body>
</html>
